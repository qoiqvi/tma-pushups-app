# Инструкция по настройке PushUps Tracker Bot

## Простая система авторизации

Мы реализовали простую систему авторизации, которая:

1. **Не требует сложной валидации** Telegram initData
2. **Работает через заголовок X-User-Id** для API запросов
3. **Автоматически создает пользователей** через команду /start в боте

## Настройка бота

### 1. Создайте бота в Telegram

1. Откройте [@BotFather](https://t.me/botfather)
2. Отправьте команду `/newbot`
3. Введите имя бота (например: "PushUps Tracker")
4. Введите username бота (например: `pushups_tracker_bot`)
5. Сохраните токен бота

### 2. Настройте переменные окружения

Добавьте в Vercel следующие переменные:

```env
# Обязательные
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
NEXT_PUBLIC_APP_URL=https://ваш-домен.vercel.app

# Supabase
NEXT_PUBLIC_SUPABASE_URL=ваш_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=ваш_anon_key
SUPABASE_SERVICE_ROLE_KEY=ваш_service_role_key (опционально)
```

### 3. Настройте Webhook

После деплоя на Vercel, установите webhook для бота:

```bash
curl -X POST https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook \
  -H "Content-Type: application/json" \
  -d '{"url": "https://ваш-домен.vercel.app/api/telegram/webhook"}'
```

### 4. Настройте Mini App

1. В [@BotFather](https://t.me/botfather) выберите вашего бота
2. Отправьте команду `/mybots`
3. Выберите вашего бота
4. Нажмите "Bot Settings" → "Menu Button"
5. Введите URL вашего приложения: `https://ваш-домен.vercel.app`
6. Введите название кнопки: "Открыть приложение"

## Как работает авторизация

### Для пользователей:

1. Пользователь открывает бота и отправляет `/start`
2. Бот создает пользователя в базе данных
3. Пользователь нажимает кнопку "Открыть приложение"
4. Приложение автоматически получает ID пользователя из Telegram

### Для разработчиков:

1. **На клиенте**: `getTelegramUserId()` получает ID из:
   - Telegram WebApp SDK
   - URL параметров
   - localStorage
   - Или возвращает тестовый ID в dev режиме

2. **Middleware** проверяет заголовок `X-User-Id` для всех API запросов

3. **API endpoints** используют `getUserIdFromRequest()` для получения ID пользователя

## Тестирование локально

Для локальной разработки ID пользователя автоматически устанавливается в `12345`.

Чтобы протестировать с реальным ID:

1. Откройте приложение через Telegram
2. ID будет автоматически сохранен в localStorage
3. Вы сможете использовать приложение даже вне Telegram

## Отладка

Откройте `/debug` страницу в приложении для просмотра:
- Статуса подключения
- Данных пользователя
- Результатов API запросов
- Системных логов

## Заметки

- Эта система проще официальной валидации Telegram, но подходит для большинства случаев
- Для критически важных приложений рекомендуется использовать полную валидацию initData
- Бот автоматически обновляет данные пользователя при каждом `/start`